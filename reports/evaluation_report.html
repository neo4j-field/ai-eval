<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GraphRAG Evaluation Report</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f8fafc; margin: 0; padding: 0; }
    .container { max-width: 1200px; margin: 40px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #e7edf4; padding: 32px; }
    h1 { color: #0d141c; margin-bottom: 24px; }
    table { width: 100%; border-collapse: collapse; margin-top: 24px; }
    th, td { border: 1px solid #cedbe8; padding: 12px; text-align: center; font-size: 15px; }
    th { background: #e7edf4; color: #0d141c; font-weight: bold; }
    tr:nth-child(even) { background: #f8fafc; }
    .metric { font-weight: bold; color: #1565c0; }
    .improvement { font-weight: bold; color: #0d80f2; }
  </style>
</head>
<body>
  <div class="container">
  <h1>GraphRAG Evaluation Report</h1>
  <input type="file" id="jsonFileInput" accept="application/json" />
  <div id="reportMeta"></div>
  <div id="reportTable"></div>
  </div>
  <script>
    function renderMeta(reportJson) {
      const meta = reportJson.metadata;
      let html = `<div style="margin-bottom:24px;font-size:16px;">
        <strong>Report Run On:</strong> ${meta.date_run} ${meta.gmt_time} GMT<br>
        <strong>Report Run Duration:</strong> ${meta.total_duration}
      </div>`;
      document.getElementById("reportMeta").innerHTML = html;
    }

    function renderTable(reportJson) {
      // Assume only two retrievers for improvement calculation
      const retrieverNames = [];
      const metricNames = new Set();
      // Collect retriever and metric names
      reportJson.report.forEach(q => {
        q.retrievers.forEach(r => {
          if (!retrieverNames.includes(r.name)) retrieverNames.push(r.name);
          r.answers.forEach(a => {
            Object.keys(a.scores).forEach(m => metricNames.add(m));
          });
        });
      });
      const metrics = Array.from(metricNames);
      // Table header
      let html = `<table><thead><tr>
        <th>Question</th>
        <th>Ground Truth</th>
        <th>Metric Name</th>
        <th>${retrieverNames[0]}</th>
        <th>${retrieverNames[1]}</th>
        <th>Improvement (${retrieverNames[1]} vs ${retrieverNames[0]})</th>
      </tr></thead><tbody>`;
      // Table rows with rowspan for question and ground truth
      reportJson.report.forEach(q => {
        const numMetrics = metrics.length + 1; // +1 for Response row
        // Helper to truncate and add tooltip
        function truncateWithTooltip(text) {
          if (!text) return "-";
          const safeText = String(text);
          if (safeText.length > 200) {
            return `<span title="${safeText.replace(/\"/g, '&quot;')}">${safeText.slice(0,200)}...<span style='color:#888'>(more)</span></span>`;
          } else {
            return `<span title="${safeText.replace(/\"/g, '&quot;')}">${safeText}</span>`;
          }
        }
        // Response row first
        html += `<tr>`;
        html += `<td rowspan="${numMetrics}">${truncateWithTooltip(q.question)}</td>`;
        html += `<td rowspan="${numMetrics}">${truncateWithTooltip(q.reference)}</td>`;
        html += `<td class="metric">Response</td>`;
        // Find response for both retrievers
        const r1 = q.retrievers.find(r => r.name === retrieverNames[0]);
        const r2 = q.retrievers.find(r => r.name === retrieverNames[1]);
        const r1Resp = r1 && r1.answers[0].response ? r1.answers[0].response : "-";
        const r2Resp = r2 && r2.answers[0].response ? r2.answers[0].response : "-";
        html += `<td>${truncateWithTooltip(r1Resp)}</td>`;
        html += `<td>${truncateWithTooltip(r2Resp)}</td>`;
        html += `<td class="improvement">-</td>`;
        html += `</tr>`;
        // Metric rows
        metrics.forEach((metric, idx) => {
          const r1Score = r1 && r1.answers[0].scores[metric] !== undefined ? r1.answers[0].scores[metric] : "-";
          const r2Score = r2 && r2.answers[0].scores[metric] !== undefined ? r2.answers[0].scores[metric] : "-";
          let improvement = "-";
          if (typeof r1Score === "number" && typeof r2Score === "number" && r1Score !== 0) {
            improvement = (((r2Score - r1Score) / Math.abs(r1Score)) * 100).toFixed(2) + "%";
          } else if (typeof r1Score === "number" && typeof r2Score === "number" && r1Score === 0) {
            improvement = r2Score !== 0 ? "âˆž" : "0%";
          }
          html += `<tr>`;
          html += `<td class="metric">${metric}</td>`;
          html += `<td>${r1Score}</td>`;
          html += `<td>${r2Score}</td>`;
          html += `<td class="improvement">${improvement}</td>`;
          html += `</tr>`;
        });
      });
      html += "</tbody></table>";
      document.getElementById("reportTable").innerHTML = html;
    }
    document.getElementById("jsonFileInput").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        try {
          const reportJson = JSON.parse(evt.target.result);
          renderMeta(reportJson);
          renderTable(reportJson);
        } catch (err) {
          document.getElementById("reportTable").innerHTML = "<p style='color:red'>Invalid JSON file.</p>";
        }
      };
      reader.readAsText(file);
    });
  </script>
</body>
</html>
